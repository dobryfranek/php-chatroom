<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nowa karta</title>

    <style>

    body {
        background-color: #2c2b2b;
        color: white;

        margin: 0;
        display: flex;
        flex-direction: column;
        /* justify-content: center; */
        height: 100vh;

        font-family: monospace;
        font-size: x-large;

        overflow: hidden;
        overflow-x: hidden;
    }

    
    .username {
        font-weight: bold;
        color: #8ae234;
    }
    
    
    #chat-container {
        margin-top: 1vh;
        align-self: center;
        width: calc(100vw - 1vh);
        height: 93vh;
        margin-left: 1vh;
        
        overflow-y: scroll;
    }

    #chat-container img {
        max-width: 25vw;
        max-height: 25vh;
    }
    
    #input-container {
        width: calc(100vw - 1vh);
        height: 6vh;
        margin-left: 1vh;
        margin-bottom: 1vh;
        
        text-align: left;
        cursor: default;

        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        
    }

    #text-input {
        all: unset;
        caret-color: transparent;
        background-color: #2c2b2b;

        cursor: default;

        max-width: 50vw;
        margin-left: 1ch;
    }

    .cursor {
        width: 1ch;
        height: 1lh;

        display: inline-block;
        position: fixed;
        vertical-align: text-bottom;

        background: white;
        animation: blink 1s step-start infinite;
    }

    @keyframes blink {
        50% {
            opacity: 0;
        }
    }

    ::selection {
        background: white;
        color: #2c2b2b;
    }


    .linux-button {

        padding: 4px 12px;
        border: 1px solid #444;
        background-color: #2c2b2b;
        color: #e0e0e0;
        font-family: monospace;
        font-size: 14px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .linux-button:hover {
        background-color: #3a3939;
    }
    .linux-button:active {
        background-color: #111;
    }

    #gif-menu-background {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        z-index: 100;
        background-color: rgba(0, 0, 0, 0.6);
    }

    #gif-menu-div {
        position: absolute;
        left: 50%;
        top: 50%;
        width: 33%;
        height: 66%;
        transform: translate(-50%, -50%);
        background-color: #2c2b2b;
        border-radius: 2ch;
        box-shadow: 0 0 32px rgba(0, 0, 0, 1);
        padding: 2ch;
        display: block;
    }

    </style>

</head>
<body>
    
<div id="chat-container">
    
</div>

<div id="input-container">
    <span class="input-container-span">
        <span class="username" id="username"></span>:<input type="text" id="text-input" autocomplete="off" spellcheck="false">
        <span class="cursor" id="cursor"></span>
        <button class="linux-button" style="margin-right: 1vh; float: right;" onclick="gif_popup_show()">GIF</button>
        <div id="gif-menu-background">
            <div id="gif-menu-div">
                gify tu będą
                <button class="linux-button" style="position: absolute; right: 2ch; top: 2ch" onclick="gif_popup_hide(); this.innerText = ['skończ', 'dość'][Math.floor((Math.random() * 2))]">dość</button>
            </div>
        </div>
    </span>
</div>

<script>
    
let name_span = document.getElementById("username");
let text_input = document.getElementById("text-input");
let cursor_span = document.getElementById("cursor");
let chat_container = document.getElementById("chat-container");

function gif_popup_show () {
    document.getElementById("gif-menu-background").style.display = "block";    
}

function gif_popup_hide () {
    document.getElementById("gif-menu-background").style.display = "none";    
}

function text_input_on_blur () {
    text_input.focus();
}
    
function text_input_on_input () {
    text_input.style.width = `${text_input.value.length}ch`;
}

function text_input_on_selection () {
    sel_start = text_input.selectionStart;
    sel_end = text_input.selectionEnd;


    name_length = name_span.innerText.length;
    text_input_width = text_input.getBoundingClientRect().width;

    cursor_span.style.left = `calc(${sel_start} * 1ch + ${name_length + 2} * 1ch + 1vh)`;
}

function text_input_on_keydown (event) {
    if (event.key === "Enter") {
        submit_text(text_input.value);
    }
}

text_input.addEventListener("keydown", text_input_on_keydown);

text_input.addEventListener("blur", text_input_on_blur);
text_input_on_blur();

text_input.addEventListener("input", text_input_on_input);
text_input_on_input();

text_input.addEventListener("selectionchange", text_input_on_selection);
text_input_on_selection();

function submit_text (text) {
    text_input.value = "";
    text_input_on_input();
    text_input_on_selection();

    fetch("back.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
            message: text,
        })
    })

    fetch_messages();
}

let previous_messages = "";

function fetch_messages () {
    fetch("back.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
    })
    .then(response => response.text())
    .then(messages => {
        chat_container.innerHTML = "";
        let splitted_lines = messages.split("\n").slice(0, -1);
        for (const line of splitted_lines) {
            const parts = line.split("|||");
            const username = escape_html(parts[0]);
            const rest = parts.slice(1).join("|||");
            if ((rest.slice(0, 6) == "/media" || rest.slice(0, 2) == "/m") && rest.split(" ").length == 2) {
                let media_link = rest.split(" ")[1];
                chat_container.innerHTML += `<p><span class="username">${username}</span>: <img src="${media_link}"></p>`;
            } else {
                chat_container.innerHTML += `<p><span class="username">${username}</span>: ${rest}</p>`;
            }
    }
    
    if (previous_messages != messages) {
        chat_container.scrollTop = chat_container.scrollHeight;
    }
    previous_messages = messages;

    text_input_on_selection();

})

}

function get_username () {
    user = prompt("username: ");
    if (!user) {
        user = "konformista";
    }
    user = user.trim();
    name_span.innerText = user;
    fetch("back.php", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
            set_user: user
        })
    })
    
    return user;
}

function escape_html (string) {
    return string
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
}

fetch("back.php", {
    method: "POST",
    headers: {
        "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams({
        get_user: true
    })
})
.then(response => response.text())
.then(data => {
    if (data == "konformista") {
        get_username();
    } else {
        name_span.innerText = data.trim();
    }
})

name_span.onclick = () => {
    
}

document.addEventListener("DOMContentLoaded", fetch_messages);


setInterval(fetch_messages, 500)

</script>


</body>
</html>
